# Context Auto-Update System

## Overview

The Context Auto-Update system is a self-improving mechanism that automatically updates database contexts after successful Claude Code execution. It detects file changes and intelligently creates new contexts for new features or updates existing contexts when files are modified.

## Architecture

### Core Components

1. **`src/app/Claude/lib/contextAutoUpdate.ts`** - Main utility module
   - `createProjectSnapshot()` - Creates a snapshot of file modification times before execution
   - `detectFileChanges()` - Detects created/modified/deleted files by comparing snapshots
   - `analyzeChanges()` - Determines if changes represent a new feature or updates to existing features
   - `generateContextDescription()` - Uses LLM to generate context descriptions from file contents
   - `autoUpdateContexts()` - Main orchestration function that coordinates all the above

2. **`src/app/api/claude-code/route.ts`** - API integration point
   - Creates snapshot before execution
   - Calls `autoUpdateContexts()` after successful execution
   - Returns context update results in response

3. **`src/app/Claude/lib/requirementApi.ts`** - Client API wrapper
   - Updated to accept optional `projectId` parameter
   - Logs context update results to console

4. **`src/app/Claude/ClaudeRequirementsList.tsx`** - UI component
   - Passes `activeProject.id` to execution API

## How It Works

### 1. Pre-Execution Snapshot
Before executing a Claude Code requirement, the system creates a snapshot of all source files in the project directory:
```typescript
const beforeSnapshot = createProjectSnapshot(projectPath);
// Returns: Map<relativePath, modificationTimeMs>
```

### 2. Execution
Claude Code executes the requirement, potentially creating/modifying/deleting files.

### 3. Post-Execution Detection
After successful execution, the system:
1. Scans the project directory again
2. Compares with the snapshot to detect changes
3. Categorizes files as: `created`, `modified`, or `deleted`

### 4. Change Analysis
The system analyzes the detected changes:

**New Feature Detection:**
- Created files exist
- No existing contexts contain these files
- Heuristic: Extracts feature name from path pattern (e.g., `app/features/<feature-name>/`)

**Existing Feature Update:**
- Files are created/deleted/modified within directories tracked by existing contexts
- Context file paths need to be updated
- Context descriptions should be regenerated

### 5. Context Operations

**Creating New Context:**
```typescript
{
  projectId: string,
  groupId: null,  // No group by default
  name: string,   // Inferred from directory structure
  description: string,  // Generated by LLM from file contents
  filePaths: string[]   // List of created files
}
```

**Updating Existing Context:**
```typescript
{
  file_paths: string[],     // Updated list (removed deleted, added created)
  description: string        // Regenerated by LLM
}
```

### 6. LLM Description Generation
The system uses Anthropic Claude to generate concise context descriptions:
- Reads up to 10 files (first 500 chars each)
- Sends to LLM with prompt: "Generate a concise 1-2 sentence description"
- Falls back to generic description if LLM fails

## File Filtering

The system only tracks source code files with extensions:
- TypeScript/JavaScript: `.ts`, `.tsx`, `.js`, `.jsx`
- Styles: `.css`, `.scss`
- Documentation: `.md`
- Configuration: `.json`

**Ignored Directories:**
- `node_modules/`
- `.git/`
- `.next/`
- `dist/`
- `build/`

## Usage

### Automatic (Default)
The system runs automatically after every successful Claude Code execution if:
1. The execution API call includes `projectId`
2. The project directory is accessible

### Manual Invocation
```typescript
import { createProjectSnapshot, autoUpdateContexts } from '@/app/Claude/lib/contextAutoUpdate';

// Before making changes
const snapshot = createProjectSnapshot(projectPath);

// ... make changes ...

// After changes
const results = await autoUpdateContexts(projectId, projectPath, snapshot);

console.log(results);
// [
//   {
//     success: true,
//     contextId: 'ctx-123',
//     action: 'created',
//     message: 'Created new context "authentication" with 5 files'
//   },
//   {
//     success: true,
//     contextId: 'ctx-456',
//     action: 'updated',
//     message: 'Updated context "user-profile" (8 files)'
//   }
// ]
```

## Response Types

### ContextUpdateResult
```typescript
interface ContextUpdateResult {
  success: boolean;
  contextId?: string;
  action: 'created' | 'updated' | 'none';
  message?: string;
  error?: string;
}
```

### FileChange
```typescript
interface FileChange {
  path: string;           // Absolute path
  status: 'created' | 'modified' | 'deleted';
  relativePath: string;   // Path relative to project root
}
```

## Examples

### Example 1: New Feature Creation
**Scenario:** Claude Code creates a new authentication feature

**Changes Detected:**
```typescript
[
  { path: 'app/features/authentication/LoginForm.tsx', status: 'created', relativePath: 'app/features/authentication/LoginForm.tsx' },
  { path: 'app/features/authentication/lib/validateCredentials.ts', status: 'created', relativePath: 'app/features/authentication/lib/validateCredentials.ts' },
  { path: 'app/features/authentication/index.tsx', status: 'created', relativePath: 'app/features/authentication/index.tsx' }
]
```

**Result:**
```typescript
{
  success: true,
  contextId: 'ctx-auth-001',
  action: 'created',
  message: 'Created new context "authentication" with 3 files'
}
```

### Example 2: Existing Feature Update
**Scenario:** Claude Code adds a new component to an existing user-profile feature

**Changes Detected:**
```typescript
[
  { path: 'app/features/user-profile/components/UserSettings.tsx', status: 'created', relativePath: 'app/features/user-profile/components/UserSettings.tsx' },
  { path: 'app/features/user-profile/index.tsx', status: 'modified', relativePath: 'app/features/user-profile/index.tsx' }
]
```

**Result:**
```typescript
{
  success: true,
  contextId: 'ctx-profile-001',
  action: 'updated',
  message: 'Updated context "user-profile" (5 files)'
}
```

## Configuration

### Environment Variables
- `ANTHROPIC_API_KEY` - Required for LLM-based description generation

### Customization Points

**Adjust file extensions:**
```typescript
// In contextAutoUpdate.ts
const ext = path.extname(entry.name).toLowerCase();
if (['.ts', '.tsx', '.js', '.jsx', /* add more */].includes(ext)) {
  // Track file
}
```

**Adjust ignored directories:**
```typescript
if (
  relativePath.includes('node_modules') ||
  relativePath.includes('.git') ||
  /* add more */
) {
  continue;
}
```

**Adjust LLM parameters:**
```typescript
const response = await anthropic.generate({
  prompt: userPrompt,
  systemPrompt,
  maxTokens: 200,      // Adjust for longer descriptions
  temperature: 0.5,    // Adjust creativity
  projectId: 'context-gen',
});
```

## Error Handling

The system is designed to be non-intrusive:
- Context update failures **do not** fail the Claude Code execution
- Errors are logged to console but not thrown
- Each context update is wrapped in try-catch
- Partial success is possible (some contexts update, others fail)

## Performance Considerations

1. **Snapshot Creation:** O(n) where n = number of source files
   - Typically < 100ms for projects with < 10,000 files

2. **Change Detection:** O(n) comparison of snapshots
   - Typically < 50ms

3. **LLM Description Generation:** Network-bound
   - ~500-1000ms per context
   - Runs concurrently for multiple contexts

4. **Database Operations:** Synchronous SQLite
   - < 10ms per context

**Total overhead:** 1-3 seconds per execution (mostly LLM time)

## Future Enhancements

1. **Smart dependency inclusion:** Automatically include related files based on imports
2. **Context group auto-assignment:** Use LLM to determine appropriate context group
3. **Change summary:** Generate a summary of what changed and why
4. **Confidence scoring:** Assign confidence scores to context assignments
5. **User review:** Optional review step before applying context updates
6. **Batch processing:** Group multiple small changes into single context updates

## Troubleshooting

### Context not auto-created
**Check:**
1. Is `projectId` being passed to the execution API?
2. Are files being created in a recognizable pattern (e.g., `app/features/<name>/`)?
3. Check console logs for error messages

### Context description is generic
**Possible causes:**
1. `ANTHROPIC_API_KEY` not set
2. LLM API call failed (check network/quota)
3. Files are too short or unclear

### Existing context not updated
**Check:**
1. Are changed files part of the context's `file_paths`?
2. Did the change detection capture the modifications?
3. Check console logs for normalization issues

### Performance issues
**Solutions:**
1. Reduce `maxTokens` for LLM calls
2. Skip LLM description generation (use generic descriptions)
3. Limit number of files read per context
4. Add more directories to ignore list

## API Reference

See inline JSDoc comments in `contextAutoUpdate.ts` for detailed parameter and return type documentation.
