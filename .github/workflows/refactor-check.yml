name: Automated Refactor Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - master
      - develop
  workflow_dispatch:
    inputs:
      create_pr:
        description: 'Create PR with refactor suggestions'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  refactor-analysis:
    name: Run Refactor Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run refactor analysis
        id: refactor
        run: |
          npm run refactor:ci -- \
            --project ./src \
            --output refactor-results.json \
            --severity medium \
            --verbose
        continue-on-error: true

      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: refactor-results
          path: refactor-results.json
          retention-days: 30

      - name: Parse results
        id: parse
        if: always()
        run: |
          if [ -f refactor-results.json ]; then
            TOTAL=$(jq -r '.summary.totalIssues' refactor-results.json)
            CRITICAL=$(jq -r '.summary.criticalIssues' refactor-results.json)
            HIGH=$(jq -r '.summary.highIssues' refactor-results.json)
            MEDIUM=$(jq -r '.summary.mediumIssues' refactor-results.json)
            LOW=$(jq -r '.summary.lowIssues' refactor-results.json)

            echo "total=$TOTAL" >> $GITHUB_OUTPUT
            echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
            echo "high=$HIGH" >> $GITHUB_OUTPUT
            echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
            echo "low=$LOW" >> $GITHUB_OUTPUT
          else
            echo "total=0" >> $GITHUB_OUTPUT
            echo "critical=0" >> $GITHUB_OUTPUT
            echo "high=0" >> $GITHUB_OUTPUT
            echo "medium=0" >> $GITHUB_OUTPUT
            echo "low=0" >> $GITHUB_OUTPUT
          fi

      - name: Post PR comment
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request' && always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const total = '${{ steps.parse.outputs.total }}';
            const critical = '${{ steps.parse.outputs.critical }}';
            const high = '${{ steps.parse.outputs.high }}';
            const medium = '${{ steps.parse.outputs.medium }}';
            const low = '${{ steps.parse.outputs.low }}';

            let body = '## = Refactor Analysis Results\n\n';

            if (total === '0') {
              body += ' No refactoring issues found!\n';
            } else {
              body += `Found **${total}** potential refactoring opportunities:\n\n`;
              body += `| Severity | Count |\n`;
              body += `|----------|-------|\n`;
              body += `| =4 Critical | ${critical} |\n`;
              body += `| =à High | ${high} |\n`;
              body += `| =á Medium | ${medium} |\n`;
              body += `| =â Low | ${low} |\n\n`;

              if (fs.existsSync('refactor-results.json')) {
                const results = JSON.parse(fs.readFileSync('refactor-results.json', 'utf-8'));

                if (results.summary.categoryCounts) {
                  body += '\n### Issues by Category\n\n';
                  Object.entries(results.summary.categoryCounts)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([category, count]) => {
                      body += `- **${category}**: ${count}\n`;
                    });
                }
              }

              body += '\n---\n';
              body += '*Download the full analysis report from the workflow artifacts.*\n';
            }

            body += '\n> Generated by Vibeman Refactor CI';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Create status check
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request' && always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const critical = parseInt('${{ steps.parse.outputs.critical }}');
            const high = parseInt('${{ steps.parse.outputs.high }}');
            const total = parseInt('${{ steps.parse.outputs.total }}');

            let conclusion = 'success';
            let summary = 'No critical refactoring issues found';

            if (critical > 0) {
              conclusion = 'failure';
              summary = `Found ${critical} critical refactoring issue(s)`;
            } else if (high > 0) {
              conclusion = 'neutral';
              summary = `Found ${high} high-priority refactoring issue(s)`;
            } else if (total > 0) {
              conclusion = 'success';
              summary = `Found ${total} minor refactoring opportunity/opportunities`;
            }

            github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Refactor Quality Check',
              head_sha: context.payload.pull_request.head.sha,
              status: 'completed',
              conclusion: conclusion,
              output: {
                title: 'Refactor Analysis',
                summary: summary,
                text: `Total issues: ${total}\n- Critical: ${critical}\n- High: ${high}\n- Medium: ${medium}\n- Low: ${low}`
              }
            });

      - name: Fail on critical issues
        if: steps.parse.outputs.critical != '0'
        run: |
          echo "L Found ${{ steps.parse.outputs.critical }} critical refactoring issue(s)"
          exit 1

  create-refactor-pr:
    name: Create Refactor PR
    runs-on: ubuntu-latest
    needs: refactor-analysis
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.create_pr == 'true') ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'auto-refactor'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download analysis results
        uses: actions/download-artifact@v4
        with:
          name: refactor-results

      - name: Setup Git
        run: |
          git config --global user.name "Vibeman Bot"
          git config --global user.email "bot@vibeman.dev"

      - name: Create refactor PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npm run create-refactor-pr -- \
            --results refactor-results.json \
            --verbose
